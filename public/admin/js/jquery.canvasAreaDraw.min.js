/*!
 * Borzakap - Idilika Avenue v0.0.1 (https://avenue.idilika.com.ua)
 * Copyright 2021-2021 Borzakap
 */

!function(m){m.fn.canvasAreaDraw=function(n){this.each(function(t,e){o.apply(e,[t,e,n])})};var o=function(t,e,n){var f,r,s,i,u,l=!1,o=m.extend({imageUrl:m(this).attr("data-image-url")},n),a=m(e).val().replace(/[^0-9\,]/gi,""),c=a.length?a.split(",").map(function(t){return parseInt(t,10)}):[],h=m('<button type="button" class="btn"><i class="icon-trash"></i>Очистить</button>'),g=m("<canvas>"),d=g[0].getContext("2d"),p=new Image,v=function(){g.attr("height",p.height).attr("width",p.width),r()};m(p).on("load",v),p.src=o.imageUrl,p.loaded&&v(),g.css({background:"url("+p.src+")"}),n=m("<div></div>"),m(n).addClass("canvas-wrapper"),m(n).css({"max-width":"100%"}),m(n).css({"overflow-y":"hidden"}),m(n).css({"overflow-x":"scroll"}),m(n).append(g),m(e).after(n,h),a=function(){c=[],r()},s=function(t){t.offsetX||(t.offsetX=t.pageX-m(t.target).offset().left,t.offsetY=t.pageY-m(t.target).offset().top),c[f]=Math.round(t.offsetX),c[f+1]=Math.round(t.offsetY),r()},i=function(t){t.offsetX||(t.offsetX=t.pageX-m(t.target).offset().left,t.offsetY=t.pageY-m(t.target).offset().top),l=l||{x:Math.round(t.offsetX),y:Math.round(t.offsetY)};for(var e={x:Math.round(t.offsetX),y:Math.round(t.offsetY)},n=0;n<c.length;n++)c[n]=e.x-l.x+c[n],c[++n]=e.y-l.y+c[n];l=e,r()},o=function(){m(this).off("mousemove"),u(),f=null},v=function(t){t.preventDefault(),t.offsetX||(t.offsetX=t.pageX-m(t.target).offset().left,t.offsetY=t.pageY-m(t.target).offset().top);for(var e=t.offsetX,n=t.offsetY,o=0;o<c.length;o+=2)if(dis=Math.sqrt(Math.pow(e-c[o],2)+Math.pow(n-c[o+1],2)),dis<6)return c.splice(o,2),r(),u(),!1;return!1},n=function(t){var e,n,o=c.length;if(3===t.which)return!1;if(t.preventDefault(),t.offsetX||(t.offsetX=t.pageX-m(t.target).offset().left,t.offsetY=t.pageY-m(t.target).offset().top),e=t.offsetX,n=t.offsetY,6<=c.length){t=getCenter();if(d.fillRect(t.x-4,t.y-4,8,8),Math.sqrt(Math.pow(e-t.x,2)+Math.pow(n-t.y,2))<6)return l=!1,m(this).on("mousemove",i),!1}for(var a=0;a<c.length;a+=2)if(Math.sqrt(Math.pow(e-c[a],2)+Math.pow(n-c[a+1],2))<6)return f=a,m(this).on("mousemove",s),!1;for(a=0;a<c.length;a+=2)1<a&&y(e,n,c[a],c[a+1],c[a-2],c[a-1],!0)<6&&(o=a);return c.splice(o,0,Math.round(e),Math.round(n)),f=o,m(this).on("mousemove",s),r(),u(),!1},r=function(){if(d.canvas.width=d.canvas.width,u(),!(c.length<2)){var t;d.globalCompositeOperation="destination-over",d.fillStyle="rgb(255,255,255)",d.strokeStyle="rgb(255,20,20)",d.lineWidth=1,6<=c.length&&(t=getCenter(),d.fillRect(t.x-4,t.y-4,8,8)),d.beginPath(),d.moveTo(c[0],c[1]);for(var e=0;e<c.length;e+=2)d.fillRect(c[e]-2,c[e+1]-2,4,4),d.strokeRect(c[e]-2,c[e+1]-2,4,4),2<c.length&&1<e&&d.lineTo(c[e],c[e+1]);d.closePath(),d.fillStyle="rgba(255,0,0,0.3)",d.fill(),d.stroke()}},u=function(){m(e).val(c.join(","))},getCenter=function(){for(var t=[],e=0;e<c.length;e++)t.push({x:c[e],y:c[++e]});var n=t[0],o=t[t.length-1];n.x==o.x&&n.y==o.y||t.push(n);for(var a,f,r,s=0,i=0,u=0,l=t.length,e=0,h=l-1;e<l;h=e++)a=t[e],f=t[h],s+=r=a.x*f.y-f.x*a.y,i+=(a.x+f.x)*r,u+=(a.y+f.y)*r;return{x:i/(r=3*s),y:u/r}},m(e).on("change",function(){var t=m(e).val().replace(/[^0-9\,]/gi,"");c=t.length?t.split(",").map(function(t){return parseInt(t,10)}):[],r()}),m(document).find(h).click(a),m(document).find(g).on("mousedown",n),m(document).find(g).on("contextmenu",v),m(document).find(g).on("mouseup",o)};m(document).ready(function(){m(".canvas-area[data-image-url]").canvasAreaDraw()});var y=function(n,o,a,f,r,s,t){function e(t,e,n,o){return Math.sqrt((t-=n)*t+(e-=o)*e)}if(!t||(t=function(){if(!(r-a))return{x:a,y:o};if(!(s-f))return{x:n,y:f};var t,e=-1/((s-f)/(r-a));return{x:t=(r*(n*e-o+f)+a*(n*-e+o-s))/(e*(r-a)+f-s),y:e*t-e*n+o}}()).x>=Math.min(a,r)&&t.x<=Math.max(a,r)&&t.y>=Math.min(f,s)&&t.y<=Math.max(f,s)){var i=f-s,u=r-a;return Math.abs(i*n+u*o+(a*s-f*r))/Math.sqrt(i*i+u*u)}i=e(n,o,a,f),u=e(n,o,r,s);return u<i?u:i}}(jQuery);