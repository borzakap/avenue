/*!
 * Borzakap - Idilika Avenue v0.0.1 (https://avenue.idilika.com.ua)
 * Copyright 2021-2021 Borzakap
 */

!function(m){m.fn.canvasAreaDraw=function(n){this.each(function(t,e){o.apply(e,[t,e,n])})};var o=function(t,e,n){var a,r,i,s,u,h=!1,o=m.extend({imageUrl:m(this).attr("data-image-url")},n),f=m(e).val().replace(/[^0-9\,]/gi,""),c=f.length?f.split(",").map(function(t){return parseInt(t,10)}):[],l=m('<button type="button" class="btn"><i class="icon-trash"></i>Очистить</button>'),g=m("<canvas>"),p=g[0].getContext("2d"),d=new Image,v=function(){g.attr("height",d.height).attr("width",d.width),r()};m(d).on("load",v),d.src=o.imageUrl,d.loaded&&v(),g.css({background:"url("+d.src+")"}),m(e).after("<br>",g,"<br>",l),n=function(){c=[],r()},i=function(t){t.offsetX||(t.offsetX=t.pageX-m(t.target).offset().left,t.offsetY=t.pageY-m(t.target).offset().top),c[a]=Math.round(t.offsetX),c[a+1]=Math.round(t.offsetY),r()},s=function(t){t.offsetX||(t.offsetX=t.pageX-m(t.target).offset().left,t.offsetY=t.pageY-m(t.target).offset().top),h=h||{x:Math.round(t.offsetX),y:Math.round(t.offsetY)};for(var e={x:Math.round(t.offsetX),y:Math.round(t.offsetY)},n=0;n<c.length;n++)c[n]=e.x-h.x+c[n],c[++n]=e.y-h.y+c[n];h=e,r()},f=function(){m(this).off("mousemove"),u(),a=null},o=function(t){t.preventDefault(),t.offsetX||(t.offsetX=t.pageX-m(t.target).offset().left,t.offsetY=t.pageY-m(t.target).offset().top);for(var e=t.offsetX,n=t.offsetY,o=0;o<c.length;o+=2)if(dis=Math.sqrt(Math.pow(e-c[o],2)+Math.pow(n-c[o+1],2)),dis<6)return c.splice(o,2),r(),u(),!1;return!1},v=function(t){var e,n,o=c.length;if(3===t.which)return!1;if(t.preventDefault(),t.offsetX||(t.offsetX=t.pageX-m(t.target).offset().left,t.offsetY=t.pageY-m(t.target).offset().top),e=t.offsetX,n=t.offsetY,6<=c.length){t=getCenter();if(p.fillRect(t.x-4,t.y-4,8,8),Math.sqrt(Math.pow(e-t.x,2)+Math.pow(n-t.y,2))<6)return h=!1,m(this).on("mousemove",s),!1}for(var f=0;f<c.length;f+=2)if(Math.sqrt(Math.pow(e-c[f],2)+Math.pow(n-c[f+1],2))<6)return a=f,m(this).on("mousemove",i),!1;for(f=0;f<c.length;f+=2)1<f&&y(e,n,c[f],c[f+1],c[f-2],c[f-1],!0)<6&&(o=f);return c.splice(o,0,Math.round(e),Math.round(n)),a=o,m(this).on("mousemove",i),r(),u(),!1},r=function(){if(p.canvas.width=p.canvas.width,u(),!(c.length<2)){var t;p.globalCompositeOperation="destination-over",p.fillStyle="rgb(255,255,255)",p.strokeStyle="rgb(255,20,20)",p.lineWidth=1,6<=c.length&&(t=getCenter(),p.fillRect(t.x-4,t.y-4,8,8)),p.beginPath(),p.moveTo(c[0],c[1]);for(var e=0;e<c.length;e+=2)p.fillRect(c[e]-2,c[e+1]-2,4,4),p.strokeRect(c[e]-2,c[e+1]-2,4,4),2<c.length&&1<e&&p.lineTo(c[e],c[e+1]);p.closePath(),p.fillStyle="rgba(255,0,0,0.3)",p.fill(),p.stroke()}},u=function(){m(e).val(c.join(","))},getCenter=function(){for(var t=[],e=0;e<c.length;e++)t.push({x:c[e],y:c[++e]});var n=t[0],o=t[t.length-1];n.x==o.x&&n.y==o.y||t.push(n);for(var f,a,r,i=0,s=0,u=0,h=t.length,e=0,l=h-1;e<h;l=e++)f=t[e],a=t[l],i+=r=f.x*a.y-a.x*f.y,s+=(f.x+a.x)*r,u+=(f.y+a.y)*r;return{x:s/(r=3*i),y:u/r}},m(e).on("change",function(){var t=m(e).val().replace(/[^0-9\,]/gi,"");c=t.length?t.split(",").map(function(t){return parseInt(t,10)}):[],r()}),m(document).find(l).click(n),m(document).find(g).on("mousedown",v),m(document).find(g).on("contextmenu",o),m(document).find(g).on("mouseup",f)};m(document).ready(function(){m(".canvas-area[data-image-url]").canvasAreaDraw()});var y=function(n,o,f,a,r,i,t){function e(t,e,n,o){return Math.sqrt((t-=n)*t+(e-=o)*e)}if(!t||(t=function(){if(!(r-f))return{x:f,y:o};if(!(i-a))return{x:n,y:a};var t,e=-1/((i-a)/(r-f));return{x:t=(r*(n*e-o+a)+f*(n*-e+o-i))/(e*(r-f)+a-i),y:e*t-e*n+o}}()).x>=Math.min(f,r)&&t.x<=Math.max(f,r)&&t.y>=Math.min(a,i)&&t.y<=Math.max(a,i)){var s=a-i,u=r-f;return Math.abs(s*n+u*o+(f*i-a*r))/Math.sqrt(s*s+u*u)}s=e(n,o,f,a),u=e(n,o,r,i);return u<s?u:s}}(jQuery);